<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MineSweeper</title>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
  <style>
      * {
        box-sizing: border-box;
        font-family: sans-serif;
        font-size: 14px;
      }
      .row {
        display: flex;
      }
      .row div {
        width: 20px;
        height: 20px;
        margin: 2px;
        border: 1px solid black;
        text-align: center;
        line-height: 20px;
        background: #D2D2D2;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        -webkit-transition: background-color 1s linear, color 1s linear;
        -moz-transition: background-color 1s linear, color 1s linear;
        transition: background-color 1s linear, color 1s linear;
        color: #D2D2D2;
        border: 1px solid #D2D2D2;
        border-radius: 2px;
      }
      .row div.mine-clicked {
        color: black;
      }
      .row div.empty {
        background: white;
      }
      #userInput  { display: table; margin-bottom: 5px }
      div.item-row  { display: table-row; height: 25px; transition: display 1s linear }
      label { display: table-cell; width: 230px; }
      input { display: table-cell; }
      #errorMessage { color: red; }
      div.item-row.hide {
        display: none;
      }
    </style>
    <script>
      window.onload = function () {
        const Timer = (function() {
          // add 5 minutes to current time
          let futureTimerDate;
          let handle;
          const timerDiv = document.getElementById('timer');
          function setTime(totalTime) {
            futureTimerDate =  new Date().getTime() + totalTime * 60000;
            timerDiv.innerText = `${totalTime} : 00`;
            handle = setInterval(function() {
              let timeDiff = futureTimerDate - new Date().getTime();
              let minutes = Math.floor(timeDiff / 60000);
              let seconds = Math.round((timeDiff / 1000) % 60);
              timerDiv.innerText = `${minutes} : ${seconds}`;
              if (minutes + seconds === 0) {
                clearInterval(handle);
                Minesweeper.errorMsgHandler('Sorry, time out, game over. Better luck next time!');
              }
            }, 1000);
          }
          return {
            init: setTime
          };
        })();
        const Minesweeper = (function(){
          let sizeX, sizeY, numberOfMines;
          let data = []; // 1 indicates mine present ex: data = [[0,0,1,0,], [...]]
          let randomMines = [];
          let gameOver = false;
          const errorDiv = document.getElementById('errorMessage');
          const colorMap = {
            1: 'RED',
            2: 'PURPLE',
            3: 'SEAGREEN',
            4: 'TOMATO',
            5: 'INDIGO',
            6: 'DARKRED',
            7: 'HOTPINK',
            8: 'LIGHTSALMON'
          };
          let x = Math.floor(Math.random() * sizeX);
          let y = Math.floor(Math.random() * sizeY);

          function init(x, y, n) {
            sizeX = x;
            sizeY = y;
            numberOfMines = n;
            clearData();
            createDOM();
            setRandomMineSlots();
            setMinesData();
            handleClick();
            //revealMines();
          }
          function setMinesData() {
            for (let i = 0; i < sizeX; i++) {
              data.push([]);
              for (let j = 0; j < sizeY; j++) {
                data[i].push(0);
              }
            }
            for (let pos of randomMines) {
              const x = getX(pos);
              const y = getY(pos);
              data[x][y] = 1;
            }
          }
          function setRandomMineSlots() {
            for (let i = 0; i < numberOfMines; i++) {
              randomMines.push(getRandom());
            }
          }
          function revealMines() {
            for (let mine of randomMines) {
              const div = document.querySelector(`[data-position='${mine}']`);
              div.classList.add('mine-clicked');
              div.innerHTML = '<i class="fa fa-bomb"></i>';
            }
          }
          function getRandom() {
            const rand = Math.ceil(Math.random() * (sizeX * sizeY));
            if (randomMines.indexOf(rand) !== -1) {
              return getRandom(); // return stmt is important here
            }
            return rand;
          }
          function handleErrorMessage(msg, state = 'open') {
            errorDiv.innerText = msg;
            state === 'hide' ? errorDiv.classList.add('hide') : errorDiv.classList.remove('hide');
            gameOver = true;
          }
          function clearData() {
            const container = document.getElementById('mineSweeper');
            container.innerHTML = '';
            data = [];
            randomMines = [];
            handleErrorMessage('', 'hide');
            gameOver = false;
          }
          function createDOM() {
            const container = document.getElementById('mineSweeper');
            for (let i = 0; i < sizeX; i++) {
              const div = document.createElement('div');
              div.classList.add('row');
              container.appendChild(div);
            }
            const rows = document.getElementsByClassName('row');
            for (let i = 0; i < rows.length; i++) {
              for (let j = 1; j <= sizeY; j++) {
                const div = document.createElement('div');
                div.setAttribute('data-position', (sizeY * i + j).toString());
                rows[i].appendChild(div);
              }
            }
          }
          function clickSquare() {
            if (!gameOver && !this.classList.contains('opened')) {
              this.classList.add('opened');
              const pos = this.dataset.position;
              const x = getX(pos);
              const y = getY(pos);

              if (data[x][y]) {
                // square contains mine
                handleErrorMessage('Sorry that you lost! Game over, better luck next time!');
                revealMines();
              } else {
                const neighbors = getAdjacents(x, y);
                let adjacentMines = 0;
                for (let square of neighbors) {
                  adjacentMines += data[square[0]][square[1]];
                }
                if (adjacentMines > 0) {
                  this.innerText = adjacentMines;
                  this.style.color = colorMap[adjacentMines];
                } else {
                  // 3rd condition, no mine in it nor any adjacent mines
                  this.classList.add('empty');
                  for (let square of neighbors) {
                    const pos = square[2];
                    const div = document.querySelector(`[data-position='${pos}']`);
                    clickSquare.call(div);
                  }
                }
              }
              checkUserWin();
            }
          }
          function checkUserWin() {
            const openedDivs = document.querySelectorAll('.row div.opened');
            if (!gameOver && openedDivs.length + randomMines.length === (sizeX * sizeY)) {
              handleErrorMessage("Congrats!!! You won!! Game over, we'd love to see you again!!");
              revealMines();
            }
          }
          function handleClick() {
            const squares = document.querySelectorAll('.row div');
            for (let square of squares) {
              square.addEventListener('click', function(event) {
                clickSquare.call(this);
              });
            }
          }
          function getX(position) {
            return Math.floor((position - 1)/sizeY);
          }
          function getY(position) {
            return (position - 1) % sizeY;
          }
          function getPosition(x, y) {
            return (x) * sizeY + y + 1;
          }
          function clampX(num) {
            const maxX = sizeX - 1;
            return Math.min(Math.max(0, num), maxX);
          }
          function clampY(num) {
            const maxY = sizeY - 1;
            return Math.min(Math.max(0, num), maxY);
          }
          function getAdjacents(x, y) {
            const neighbours = [];
            for (let i = clampX(x-1); i <= clampX(x+1); i++) {
              for (let j=clampY(y-1); j <= clampY(y+1); j++) {
                if (i === x && j === y) continue;
                  neighbours.push([i, j, getPosition(i, j)]);
              }
            }
            return neighbours;
          }
          return {
            init,
            errorMsgHandler: handleErrorMessage
          };

        })();

        document.getElementById('generateBtn').addEventListener('click', function (event) {
          const rowVal = Number(document.getElementById('rowCount').value);
          const colVal = Number(document.getElementById('colCount').value);
          const mines = Number(document.getElementById('mineCount').value);
          const errorMsgElm = document.getElementById('errorMessage');
          if (!rowVal || !colVal || !mines) {
            Minesweeper.errorMsgHandler('Please enter all the three input values.');
          } else if (mines > (rowVal * colVal)) {
            Minesweeper.errorMsgHandler('Number of mines cannot exceed total number of available slots.');
          } else {
            Minesweeper.init(rowVal, colVal, mines);
            Timer.init(5);
          }
        });
      }
    </script>
</head>
<body>
  <section id="userInput">
    <div class="item-row">
      <label for="rowCount">Enter number of grid rows: </label>
      <input id="rowCount" placeholder="rows" type="number">
    </div>
    <div class="item-row">
      <label for="colCount">Enter number of grid columns: </label>
      <input id="colCount" placeholder="columns" type="number">
    </div>
    <div class="item-row">
      <label for="mineCount">Enter number of mines: </label>
      <input id="mineCount" placeholder="mine count" type="number">
    </div>
    <div class="item-row">
      <button type="button" id="generateBtn">Generate</button>
    </div>
  </section>
  <div class="item-row">
    Timer: <span id="timer"></span>
  </div>
  <div class="item-row" id="errorMessage"></div>
  <section id="mineSweeper">
  </section>
</body>
</html>